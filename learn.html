<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#040921">
        <title>Mimir: Learn Cards</title>
        <link rel="stylesheet" href="css/styles.css">
        <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
        <!-- Dexie IndexedDB wrapper -->
        <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
        <script src="js/database-dexie.js"></script>
        <script src="js/scheduler.js"></script>
        <script src="js/learning-scheduler.js"></script>
        <script src="js/card-learning.js"></script>
        <script src="js/focus-mode.js"></script>
        <script src="js/theme-manager.js"></script>

        <!-- Mobile app-like experience script -->
        <script>
            // Hide URL bar on mobile devices
            function hideAddressBar() {
                if (window.innerHeight < window.outerHeight) {
                    // Scroll to hide address bar
                    setTimeout(() => {
                        window.scrollTo(0, 1);
                        // Reset scroll position
                        setTimeout(() => {
                            window.scrollTo(0, 0);
                        }, 100);
                    }, 100);
                }
            }

            // Trigger on page load and orientation change
            window.addEventListener('load', hideAddressBar);
            window.addEventListener('orientationchange', () => {
                setTimeout(hideAddressBar, 500);
            });

            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // Prevent pull-to-refresh and overscroll
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                // Allow scrolling within learning content areas
                if (e.target.closest('.card-learning-display') ||
                    e.target.closest('.no-cards-state')) {
                    return;
                }
                // Prevent pull-to-refresh and overscroll for other areas
                e.preventDefault();
            }, { passive: false });
        </script>
    </head>
    <body>
        <!-- Smartphone-like container for desktop -->
        <div class="smartphone-container">
            <!-- Learning Component -->
            <div x-data="cardLearning()" x-init="init()" class="card-learning-container">
            <!-- Loading State -->
            <div x-show="isLoading" class="loading-state">
                <span>Loading cards for learning...</span>
            </div>

            <!-- No Deck Selected -->
            <div x-show="!isLoading && !selectedDeck" class="no-cards-state">
                <div class="no-cards-content">
                    <h2>No Deck Selected</h2>
                    <p>Please select a deck from the manage page to start learning.</p>
                    <a href="manage.html" class="cta-button">Go to Manage</a>
                </div>
            </div>

            <!-- No Cards in Deck -->
            <div x-show="!isLoading && selectedDeck && deckCards.length === 0" class="no-cards-state">
                <div class="no-cards-content">
                    <h2>No Cards Found</h2>
                    <p x-text="`No cards found in deck '${selectedDeck}'.`"></p>
                    <a href="manage.html" class="cta-button">Back to Manage</a>
                </div>
            </div>

            <!-- Learning Session Header -->
            <div x-show="!isLoading && isLearning" class="learning-header">
                <div class="learning-deck-info">
                    <h3 x-text="`Learning: ${selectedDeck}`"></h3>
                </div>
                <div class="learning-stats">
                    <div class="stat-item">
                        <span class="stat-label">Progress:</span>
                        <span class="stat-value" x-text="`${sessionStats.graduatedCards}/${sessionStats.totalCards}`"></span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Complete:</span>
                        <span class="stat-value" x-text="`${sessionStats.completionPercentage}%`"></span>
                    </div>
                </div>
                <div class="learning-actions">
                    <button @click="endLearningSession()" class="end-session-btn">End Session</button>
                </div>
            </div>

            <!-- Waiting for Next Card -->
            <div x-show="!isLoading && isLearning && currentCard && timeUntilNext > 0" class="waiting-state">
                <div class="waiting-content">
                    <h3>Next card in:</h3>
                    <div class="countdown-timer" x-text="formatTime(timeUntilNext)"></div>
                    <p>Take a moment to reflect on what you learned!</p>
                </div>
            </div>

            <!-- Learning Session - Question -->
            <div x-show="!isLoading && isLearning && currentCard && timeUntilNext <= 0 && !showingAnswer" class="learning-session">
                <div class="card-learning-display">
                    <div class="card-prompt-learning">
                        <span x-text="currentCard?.prompt || 'Loading...'"></span>
                    </div>
                    <div class="card-actions-learning">
                        <button @click="showAnswer()" class="show-answer-btn">Show Answer</button>
                    </div>
                </div>
            </div>

            <!-- Learning Session - Answer -->
            <div x-show="!isLoading && isLearning && showingAnswer" class="learning-answer">
                <div class="card-learning-display">
                    <div class="card-prompt-learning">
                        <span x-text="currentCard?.prompt || 'Loading...'"></span>
                    </div>
                    <div class="divider-line"></div>
                    <div class="card-response-learning">
                        <span x-text="currentCard?.response || 'Loading...'"></span>
                    </div>
                    <div class="card-actions-learning">
                        <button @click="reviewCard(false)" class="learning-btn learning-again">Again</button>
                        <button @click="reviewCard(true)" class="learning-btn learning-good">Good</button>
                    </div>
                </div>
            </div>

            <!-- Learning Complete -->
            <div x-show="!isLoading && !isLearning && selectedDeck && deckCards.length > 0" class="learning-complete">
                <div class="complete-content">
                    <h2>ðŸŽ‰ Learning Complete!</h2>
                    <p x-text="`You've successfully learned all ${deckCards.length} cards in the '${selectedDeck}' deck.`"></p>
                    <div class="complete-actions">
                        <button @click="startLearningSession()" class="cta-button">Learn Again</button>
                        <a href="manage.html" class="secondary-button">Back to Manage</a>
                    </div>
                </div>
            </div>

            <!-- Message Display -->
            <div x-show="message" class="message-display" :class="messageType">
                <span x-text="message"></span>
                <button @click="clearMessage()" class="message-close">Ã—</button>
            </div>

            </div>

            <!-- Dual Floating Action Buttons -->
            <div class="fab-container">
                <!-- Create Cards FAB -->
                <a href="index.html" class="fab" title="Create Cards">
                    <svg class="fab-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                        <path d="m8 2.75v10.5"/>
                        <path d="m2.75 8h10.5"/>
                    </svg>
                </a>

                <!-- Manage Cards FAB -->
                <a href="manage.html" class="fab" title="Manage Cards">
                    <svg class="fab-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                        <rect height="11.5" width="8.25" y="2.75" x="1.75"/>
                        <path d="m10 3.75 4.25 2-4.25 7.5"/>
                    </svg>
                </a>
            </div>
        </div>

        <!-- Focus Mode Toggle -->
        <div id="focus-toggle" class="focus-toggle" title="Toggle Focus Mode">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6"/>
                <path d="m1 12h6m6 0h6"/>
            </svg>
        </div>

        <!-- Theme Toggle -->
        <div id="theme-toggle" class="theme-toggle" title="Toggle Theme">
            <svg class="theme-icon sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"/>
                <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            <svg class="theme-icon moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        </div>
    </body>
</html>
